// A simple document insert example, not using safe mode to ensure document persistance on MongoDB

var MongoClient = require('mongodb').MongoClient,
    req = require('request');
MongoClient.connect('mongodb://localhost:27017/test', function(err, db) {
  var noticationCollection = db.collection("notication");
  // Insert a single document
  //var inserting = [{
  //  userid:"admin",
  //  username:"admin",
  //  password:"1",
  //  tempsocketid:""
  //},
  //{
  //  userid:"sunsiyuan",
  //  username:"孙思远",
  //  password:"1",
  //  tempsocketid:""
  //}
  //];
  //collection.insertMany(
  //  inserting
  //, function(err, result) {
  //  if (err) {throw err}
  //  console.log(result);
  //});

  //var query = {
  //  "userid":"sunsiyuan"
  //};
  //var suppression = {
  //  "msgs.admin":true
  //};
  //
  //collection.find(query,suppression).toArray(function (err,result) {
  //  if(err) throw err;
  //  console.log(result[0].msgs);
  //  //如果不存在该聊天纪录,创建
  //  db.close();
  //});

  //var selector = {
  //  "userid":"sunsiyuan"
  //};
  //var _admin ="admin";
  //var msgs = JSON.parse('{ "msgs.'+_admin+'" : "2" }');
  //var document = { $set: msgs };
  //var options = {
  //  'w':1
  //};
  //collection.update(selector,document,options, function (err, result) {
  //  if(err) throw err;
  //  console.log(result);
  //  //result
  //  // result: { ok: 1, nModified: 1, n: 1 },
  //  db.close();
  //});

  ////同步数据库
  //req('http://221.6.31.42:28080/SSIL/web.usermanage/getListuser.action',function (error, response, body) {
  //  if (!error && response.statusCode == 200) {
  //    var obj = JSON.parse(body),
  //        rows = obj.rows,
  //        targetrow=[],
  //        i;
  //
  //    for(i=0;i<rows.length;i++){
  //      targetrow.push({
  //        userid:rows[i].userid,
  //        username:rows[i].name,
  //        password : "000000",
  //        tempsocketid : "",
  //        msgs : {},
  //        notication : {
  //          confirmed: [],
  //          unconfirmed: []
  //        }
  //      });
  //    }
  //    /**
  //     * "userid" : "jiangsudiaodu",
  //     "username" : "江苏调度",
  //     "password" : "000000",
  //     "tempsocketid" : "",
  //     "msgs" : {},
  //     "notication" : {
  //      "confirmed" : [],
  //      "unconfirmed" : []
  //  }
  //     */
  //
  //    userCollection.insertMany(targetrow,function(err,result){
  //      if(err) throw err;
  //      console.log(result);
  //      db.close();
  //    });
  //  }
  //});
    var filter = {noticationuuid:"e75847c2-68f2-4818-8e1e-03893c0b05b8"},
        updater = {$set:{confirms:{jiangsudiaodu:true}}};

    noticationCollection.findOneAndUpdate(filter,updater,{}, function (err, result) {
        if(err) throw err;
        console.log(result);
    });
});